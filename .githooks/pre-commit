#!/bin/bash
# ABOUTME: Pre-commit hook for embacle code quality enforcement
# ABOUTME: Checks SPDX headers, blocks suspicious files and unauthorized markdown

set -e

# Check for *.md files in root directory (except standard docs and AGENTS.md)
check_root_markdown() {
    local root_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^[^/]+\.md$' | grep -v -E '^(README|CHANGELOG|CONTRIBUTING|SECURITY|LICENSE|AGENTS)\.md$' || true)

    if [ -n "$root_md_files" ]; then
        echo "❌ ERROR: Commit blocked - Found markdown files in root directory:"
        echo "$root_md_files" | sed 's/^/  - /'
        echo ""
        echo "Only README.md, CHANGELOG.md, CONTRIBUTING.md, SECURITY.md, LICENSE.md, and AGENTS.md are allowed in the root directory."
        echo "To unstage: git reset HEAD <file>"
        return 1
    fi
    return 0
}

# Check for files with suspicious patterns (backups, old files, etc.)
check_suspicious_files() {
    local suspicious_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(bak|orig|tmp|swp)$|_old\.|old_|\.old\.|rs:' || true)

    if [ -n "$suspicious_files" ]; then
        echo "❌ ERROR: Commit blocked - Found suspicious files:"
        echo "$suspicious_files" | sed 's/^/  - /'
        echo ""
        echo "These files appear to be backups, old versions, or contain invalid patterns."
        echo "Please remove them or rename them before committing."
        return 1
    fi
    return 0
}

# Check for SPDX license headers in Rust source files
check_license_headers() {
    local missing_headers=""

    # Rust files in src/ and examples/
    local rs_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' | grep -v '/target/' || true)
    # Shell scripts
    local sh_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.sh$' || true)

    for file in $rs_files $sh_files; do
        if [ -f "$file" ] && ! grep -q "SPDX-License-Identifier:" "$file" 2>/dev/null; then
            missing_headers="$missing_headers\n  - $file"
        fi
    done

    if [ -n "$missing_headers" ]; then
        echo "❌ ERROR: Commit blocked - Missing SPDX license headers:"
        echo -e "$missing_headers"
        echo ""
        echo "All source files must have SPDX headers. Format:"
        echo "  // SPDX-License-Identifier: MIT OR Apache-2.0"
        echo "  // Copyright (c) 2026 dravr.ai"
        return 1
    fi
    return 0
}

# Main execution
main() {
    local checks_passed=true

    if ! check_root_markdown; then
        checks_passed=false
    fi

    if ! check_suspicious_files; then
        checks_passed=false
    fi

    if ! check_license_headers; then
        checks_passed=false
    fi

    if [ "$checks_passed" = false ]; then
        exit 1
    fi

    echo "✅ All pre-commit checks passed"
    exit 0
}

main "$@"